/* 
 * Autocompleter v0.1.0 - 2014-05-18 
 * Simple, easy, customisable and with cache support. 
 * http://github.com/ArtemFitiskin/jquery-autocompleter 
 * 
 * Copyright 2014 Artem Fitiskin; MIT Licensed 
 */ 

!function(a,b){"use strict";function c(b){b=a.extend({},L,b||{}),null===H&&(H=a("body"));for(var c=a(this),e=0,f=c.length;f>e;e++)d(c.eq(e),b);return c}function d(b,c){if(!b.hasClass("autocompleter-node")){c=a.extend({},c,b.data("autocompleter-options"));var d='<div class="autocompleter '+c.customClass.join(" ")+'" id="autocompleter-'+(B+1)+'">';c.hint&&(d+='<div class="autocompleter-hint"></div>'),d+='<ul class="autocompleter-list"></ul>',d+="</div>",b.addClass("autocompleter-node").after(d);var e=b.next(".autocompleter").eq(0),f=b.attr("autocomplete");b.attr("autocomplete","off");var g=a.extend({$node:b,$autocompleter:e,$selected:null,$list:null,index:-1,hintText:!1,source:!1,jqxhr:!1,response:null,focused:!1,query:"",originalAutocomplete:f,guid:B++},c);g.$autocompleter.on("mousedown.autocompleter",".autocompleter-item",g,r).data("autocompleter",g),g.$node.on("keyup.autocompleter",g,j).on("keydown.autocompleter",g,k).on("focus.autocompleter",g,l).on("blur.autocompleter",g,m).on("mousedown.autocompleter",g,n)}}function e(a,b,c){var d=[];if(a=a.toUpperCase(),b.length)for(var e=0;2>e;e++)for(var f in b)if(d.length<c)switch(e){case 0:0===b[f].label.toUpperCase().indexOf(a)&&(d.push(b[f]),delete b[f]);break;case 1:-1!=b[f].label.toUpperCase().indexOf(a)&&(d.push(b[f]),delete b[f])}return d}function f(b){if(b.query=b.$node.val().trim(),!b.empty&&0===b.query.length)return void g(b);if("object"==typeof b.source){g(b);var c=e(b.query,A(b.source),b.limit);c.length&&h(c,b)}else{b.jqxhr&&b.jqxhr.abort();var d=a.extend({limit:b.limit,query:b.query},b.combine());b.jqxhr=a.ajax({url:b.source,dataType:"json",data:d,beforeSend:function(a){if(b.$autocompleter.addClass("autocompleter-ajax"),g(b),b.cache){var c=x(this.url);c&&(a.abort(),h(c,b))}}}).done(function(a){b.cache&&w(this.url,a),h(a,b)}).always(function(){b.$autocompleter.removeClass("autocompleter-ajax")})}}function g(a){a.response=null,a.$list=null,a.$selected=null,a.index=0,a.$autocompleter.find(".autocompleter-list").empty(),a.$autocompleter.find(".autocompleter-hint").removeClass("autocompleter-hint-show").empty(),a.hintText=!1,q(null,a)}function h(a,b){i(a,b),b.$autocompleter.hasClass("autocompleter-focus")&&o(null,b)}function i(b,c){var d="";for(var e in b){var f=["autocompleter-item"];c.selectFirst&&"0"==e&&!c.changeWhenSelect&&f.push("autocompleter-item-selected");var g=new RegExp(c.query,"gi"),h=c.customLabel&&b[e][c.customLabel]?b[e][c.customLabel]:b[e].label,i=h;h=c.highlightMatches?h.replace(g,"<strong>$&</strong>"):h;var j=c.customValue&&b[e][c.customValue]?b[e][c.customValue]:b[e].value;if(c.template){var k=c.template.replace(/({{ label }})/gi,h);for(var l in b[e]){var m=new RegExp("{{ "+l+" }}","gi");k=k.replace(m,b[e][l])}h=k}d+=j?'<li data-value="'+j+'" data-label="'+i+'" class="'+f.join(" ")+'">'+h+"</li>":'<li data-label="'+i+'" class="'+f.join(" ")+'">'+h+"</li>"}if(b.length&&c.hint){var n=b[0].label.substr(0,c.query.length).toUpperCase()==c.query.toUpperCase()?b[0].label:!1;if(n&&c.query!=b[0].label){var g=new RegExp(c.query,"i"),o=n.replace(g,"<span>"+c.query+"</span>");c.$autocompleter.find(".autocompleter-hint").addClass("autocompleter-hint-show").html(o),c.hintText=o}}c.response=b,c.$autocompleter.find(".autocompleter-list").html(d),c.$selected=c.$autocompleter.find(".autocompleter-item-selected").length?c.$autocompleter.find(".autocompleter-item-selected"):null,c.$list=b.length?c.$autocompleter.find(".autocompleter-item"):null,c.index=c.$selected?c.$list.index(c.$selected):-1,c.$autocompleter.find(".autocompleter-item").each(function(b,d){a(d).data(c.response[b])})}function j(a){var b=a.data,c=a.keyCode?a.keyCode:a.which;if(40!=c&&38!=c||!b.$autocompleter.hasClass("autocompleter-show"))-1==C.indexOf(c)&&-1==b.ignoredKeyCode.indexOf(c)&&f(b);else{var d,e,g=b.$list.length;g&&(g>1?b.index==g-1?(d=b.changeWhenSelect?-1:0,e=b.index-1):0===b.index?(d=b.index+1,e=b.changeWhenSelect?-1:g-1):-1==b.index?(d=0,e=g-1):(d=b.index+1,e=b.index-1):-1==b.index?(d=0,e=0):(e=-1,d=-1),b.index=40==c?d:e,b.$list.removeClass("autocompleter-item-selected"),-1!=b.index&&b.$list.eq(b.index).addClass("autocompleter-item-selected"),b.$selected=b.$autocompleter.find(".autocompleter-item-selected").length?b.$autocompleter.find(".autocompleter-item-selected"):null,b.changeWhenSelect&&t(b))}}function k(a){var b=a.keyCode?a.keyCode:a.which,c=a.data;if(40==b||38==b)a.preventDefault(),a.stopPropagation();else if(39==b){if(c.hint&&c.hintText&&c.$autocompleter.find(".autocompleter-hint").hasClass("autocompleter-hint-show")){a.preventDefault(),a.stopPropagation();var d=c.$autocompleter.find(".autocompleter-item").length?c.$autocompleter.find(".autocompleter-item").eq(0).attr("data-label"):!1;d&&(c.query=d,s(c))}}else 13==b&&c.$autocompleter.hasClass("autocompleter-show")&&c.$selected&&r(a)}function l(a,b){if(!b){var c=a.data;c.$autocompleter.addClass("autocompleter-focus"),c.$node.prop("disabled")||c.$autocompleter.hasClass("autocompleter-show")||c.focusOpen&&(f(c),c.focused=!0,setTimeout(function(){c.focused=!1},500))}}function m(a,b){a.preventDefault(),a.stopPropagation();var c=a.data;b||(c.$autocompleter.removeClass("autocompleter-focus"),q(a))}function n(a){if("mousedown"!=a.type||-1==[2,3].indexOf(a.which)){var c=a.data;if(c.$list&&!c.focused&&!c.$node.is(":disabled"))if(F&&!G){var d=c.$select[0];if(b.document.createEvent){var e=b.document.createEvent("MouseEvents");e.initMouseEvent("mousedown",!1,!0,b,0,0,0,0,0,!1,!1,!1,!1,0,null),d.dispatchEvent(e)}else d.fireEvent&&d.fireEvent("onmousedown")}else c.$autocompleter.hasClass("autocompleter-closed")?o(a):c.$autocompleter.hasClass("autocompleter-show")&&q(a)}}function o(a,b){var b=a?a.data:b;!b.$node.prop("disabled")&&!b.$autocompleter.hasClass("autocompleter-show")&&b.$list&&b.$list.length&&(b.$autocompleter.removeClass("autocompleter-closed").addClass("autocompleter-show"),H.on("click.autocompleter-"+b.guid,":not(.autocompleter-item)",b,p))}function p(b){a(b.target).hasClass("autocompleter-node")||0===a(b.currentTarget).parents(".autocompleter").length&&q(b)}function q(a,b){var b=a?a.data:b;b.$autocompleter.hasClass("autocompleter-show")&&(b.$autocompleter.removeClass("autocompleter-show").addClass("autocompleter-closed"),H.off(".autocompleter-"+b.guid))}function r(b){if("mousedown"!=b.type||-1==[2,3].indexOf(b.which)){var c=b.data;b.preventDefault(),b.stopPropagation(),"mousedown"==b.type&&a(this).length&&(c.$selected=a(this),c.index=c.$list.index(c.$selected)),c.$node.prop("disabled")||(q(b),u(c),"click"==b.type&&c.$node.trigger("focus",[!0]))}}function s(a){t(a),v(a),f(a)}function t(a){if(a.$selected){a.hintText&&a.$autocompleter.find(".autocompleter-hint").hasClass("autocompleter-hint-show")&&a.$autocompleter.find(".autocompleter-hint").removeClass("autocompleter-hint-show");var b=a.$selected.attr(a.$selected.attr("data-value")?"data-value":"data-label");a.$node.val(b)}else a.hintText&&!a.$autocompleter.find(".autocompleter-hint").hasClass("autocompleter-hint-show")&&a.$autocompleter.find(".autocompleter-hint").addClass("autocompleter-hint-show"),a.$node.val(a.query)}function u(a){t(a),v(a),g(a)}function v(a){a.callback.call(a.$autocompleter,a.$node.val(),a.index,a.response[a.index]),a.$node.trigger("change")}function w(a,b){if(J&&a&&b){K[a]={value:b};try{localStorage.setItem(I,JSON.stringify(K))}catch(c){var d=c.code||c.number||c.message;if(22!==d)throw c;z()}}}function x(a){if(a){var b=K[a]&&K[a].value?K[a].value:!1;return b}}function y(){if(J){var a=localStorage.getItem(I)||"{}";return JSON.parse(a)}}function z(){try{localStorage.removeItem(I),K=y()}catch(a){throw a}}function A(a){if(null==a||"object"!=typeof a)return a;var b=a.constructor();for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}var B=0,C=[9,13,17,19,20,27,33,34,35,36,37,39,44,92,113,114,115,118,119,120,122,123,144,145],D=b.navigator.userAgent||b.navigator.vendor||b.opera,E=/Firefox/i.test(D),F=/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(D),G=E&&F,H=null,I="autocompleterCache",J=function(){var a="undefined"!=typeof b.localStorage;if(a)try{localStorage.setItem("autocompleter","autocompleter"),localStorage.removeItem("autocompleter")}catch(c){a=!1}return a}(),K=y(),L={source:null,empty:!0,limit:10,customClass:[],cache:!0,focusOpen:!0,hint:!1,selectFirst:!1,changeWhenSelect:!0,highlightMatches:!1,ignoredKeyCode:[],customLabel:!1,customValue:!1,template:!1,combine:a.noop,callback:a.noop},M={defaults:function(b){return L=a.extend(L,b||{}),a(this)},clearCache:function(){z()},destroy:function(){return a(this).each(function(b,c){var d=a(c).next(".autocompleter").data("autocompleter");d&&(d.jqxhr&&d.jqxhr.abort(),d.$autocompleter.hasClass("open")&&d.$autocompleter.find(".autocompleter-selected").trigger("click.autocompleter"),d.originalAutocomplete?d.$node.attr("autocomplete",d.originalAutocomplete):d.$node.removeAttr("autocomplete"),d.$node.off(".autocompleter").removeClass("autocompleter-node"),d.$autocompleter.off(".autocompleter").remove())})}};a.fn.autocompleter=function(a){return M[a]?M[a].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof a&&a?this:c.apply(this,arguments)},a.autocompleter=function(a){"defaults"===a?M.defaults.apply(this,Array.prototype.slice.call(arguments,1)):"clearCache"===a&&M.clearCache.apply(this,null)}}(jQuery,window);